#!/usr/bin/env python3
"""
ä»å·²æ”¶é›†çš„æ•°æ®ä¸­æå– Prompts å¹¶è½¬æ¢ä¸º Skills
"""

import json
import os
import hashlib
from datetime import datetime

# æ•°æ®æº
DATA_SOURCES = [
    '/root/clawd/data/prompts/github-awesome-prompts.jsonl',
    '/root/clawd/data/prompts/reddit-prompts.jsonl',
    '/root/clawd/data/prompts/hacker-news-ai.jsonl',
    '/root/clawd/data/prompts/collected.jsonl'
]

# è¾“å‡ºç›®å½•
OUTPUT_DIR = "/root/clawd/generated-skills"
PROMPT_TYPES = ['ç”Ÿå›¾', 'ç”Ÿè§†é¢‘', 'AI ç¼–ç ', 'æç¤ºè¯å·¥ç¨‹']

def extract_prompt_from_data(data):
    """ä»æ•°æ®ä¸­æå– prompt"""
    content = ''
    
    # å°è¯•ä»ä¸åŒå­—æ®µæå–
    if 'content' in data:
        content = str(data['content'])
    elif 'text' in data:
        content = str(data['text'])
    elif 'prompt' in data:
        content = str(data['prompt'])
    elif 'description' in data:
        content = str(data['description'])
    
    # æ¸…ç†å†…å®¹
    content = content.strip()
    
    # é™åˆ¶é•¿åº¦
    if len(content) > 2000:
        content = content[:2000] + "..."
    
    return content

def categorize_prompt(data):
    """åˆ†ç±» prompt ç±»å‹"""
    content = extract_prompt_from_data(data).lower()
    title = data.get('title', '').lower()
    tags = data.get('tags', [])
    
    if not content and not title:
        return 'é€šç”¨'
    
    # æ£€æŸ¥ç”Ÿå›¾ç›¸å…³å…³é”®è¯
    image_keywords = ['ç”Ÿå›¾', 'ç»˜å›¾', 'ç”»å›¾', 'å›¾ç‰‡', 'image', 'midjourney', 'dalle', 
                    'stable diffusion', 'diffusion', 'leonardo', 'firefly', 
                    'starryai', 'playgroundai', 'runwayml']
    
    # æ£€æŸ¥ç”Ÿè§†é¢‘ç›¸å…³å…³é”®è¯
    video_keywords = ['ç”Ÿè§†é¢‘', 'è§†é¢‘ç”Ÿæˆ', 'video', 'kling', 'runway', 
                    'pika', 'sora', 'åšè§†é¢‘', 'è§†é¢‘ç¼–è¾‘']
    
    # æ£€æŸ¥ AI ç¼–ç ç›¸å…³å…³é”®è¯
    coding_keywords = ['ç¼–ç ', 'ç¼–ç¨‹', 'coding', 'code', 'ä»£ç ', 'å¼€å‘', 'development',
                    'ç¨‹åºå‘˜', 'developer', 'ide', 'editor']
    
    # æ£€æŸ¥æç¤ºè¯å·¥ç¨‹ç›¸å…³å…³é”®è¯
    prompt_keywords = ['prompt', 'æç¤ºè¯', 'template', 'æ¨¡æ¿', 'æŒ‡ä»¤', 'instruction']
    
    text = content + ' ' + title + ' ' + ' '.join(str(t) for t in tags).lower()
    
    for keyword in image_keywords:
        if keyword in text:
            return 'ç”Ÿå›¾'
    
    for keyword in video_keywords:
        if keyword in text:
            return 'ç”Ÿè§†é¢‘'
    
    for keyword in coding_keywords:
        if keyword in text:
            return 'AI ç¼–ç '
    
    for keyword in prompt_keywords:
        if keyword in text:
            return 'æç¤ºè¯å·¥ç¨‹'
    
    return 'é€šç”¨'

def calculate_quality_score(data):
    """è®¡ç®—è´¨é‡åˆ†æ•°ï¼ˆ0-100ï¼‰"""
    score = 0
    
    content = extract_prompt_from_data(data)
    title = data.get('title', '')
    likes = data.get('likes', 0) or data.get('upvotes', 0) or data.get('stars', 0)
    comments = data.get('comments', 0) or data.get('num_comments', 0) or data.get('replies', 0)
    
    # å†…å®¹é•¿åº¦è¯„åˆ†
    if len(content) > 200:
        score += 10
    if len(content) > 500:
        score += 10
    if len(content) > 1000:
        score += 10
    
    # äº’åŠ¨è¯„åˆ†
    if likes > 0:
        import math
        score += min(20, math.log2(likes + 1) * 3)
    
    if comments > 0:
        import math
        score += min(10, math.log2(comments + 1) * 2)
    
    # æ ‡é¢˜é•¿åº¦è¯„åˆ†
    if len(title) > 20:
        score += 10
    if len(title) > 50:
        score += 10
    
    # åŒ…å«ç¤ºä¾‹æˆ–æ¨¡æ¿
    text = content + ' ' + title
    if 'example' in text.lower() or 'template' in text.lower() or 'ç¤ºä¾‹' in text:
        score += 20
    
    return min(100, score)

def create_skill_from_prompt(data, prompt_type):
    """ä» prompt åˆ›å»º skill"""
    content = extract_prompt_from_data(data)
    
    if not content or len(content) < 20:
        return None
    
    # ç”Ÿæˆå”¯ä¸€ ID
    content_hash = hashlib.md5(content.encode()).hexdigest()[:8]
    source_name = data.get('source', 'unknown').lower()
    skill_name = f"{prompt_type.lower()}-{source_name}-{content_hash}"
    
    # åˆ›å»º skill ç›®å½•
    skill_dir = os.path.join(OUTPUT_DIR, skill_name)
    os.makedirs(skill_dir, exist_ok=True)
    
    # ç”Ÿæˆ SKILL.md
    skill_md = f"""# {prompt_type} Prompt Skill

## æè¿°
{content[:100]}...

## ç±»å‹
- ç±»å‹: {prompt_type}
- è¯„åˆ†: {calculate_quality_score(data):.0f}/100

## Prompt
```
{content[:1000] if len(content) > 1000 else content}
```

## æ¥æºä¿¡æ¯
- æ¥æº: {data.get('source', 'N/A')}
- åŸå§‹é“¾æ¥: {data.get('url', 'N/A')}
- ä½œè€…: {data.get('author', 'N/A')}
- äº’åŠ¨: {data.get('likes', 0)} èµ

## å…ƒæ•°æ®
- æ”¶é›†æ—¶é—´: {datetime.now().isoformat()}
- Prompt ç±»å‹: {prompt_type}
- è´¨é‡åˆ†æ•°: {calculate_quality_score(data):.0f}/100

---

*Skill generated by Clawdbot*
"""
    
    # ä¿å­˜ SKILL.md
    with open(os.path.join(skill_dir, 'SKILL.md'), 'w', encoding='utf-8') as f:
        f.write(skill_md)
    
    # åˆ›å»º metadata.json
    metadata = {
        "name": f"{prompt_type} Prompt from {data.get('source', 'N/A')}",
        "version": "1.0.0",
        "description": content[:100] if len(content) > 100 else content,
        "author": "Clawdbot",
        "type": prompt_type,
        "source": data.get('source', 'N/A'),
        "url": data.get('url', ''),
        "created_at": datetime.now().isoformat()
    }
    
    with open(os.path.join(skill_dir, 'metadata.json'), 'w', encoding='utf-8') as f:
        json.dump(metadata, f, indent=2, ensure_ascii=False)
    
    return {
        'name': skill_name,
        'path': skill_dir,
        'type': prompt_type,
        'score': calculate_quality_score(data)
    }

def main():
    print("=" * 80)
    print("ğŸ”„ ä»å·²æ”¶é›†çš„æ•°æ®ä¸­æå– Prompts å¹¶è½¬æ¢ä¸º Skills")
    print("=" * 80)
    print()
    
    # åˆ›å»ºè¾“å‡ºç›®å½•
    os.makedirs(OUTPUT_DIR, exist_ok=True)
    
    # è¯»å–æ‰€æœ‰æ•°æ®
    all_data = []
    for source_file in DATA_SOURCES:
        if os.path.exists(source_file):
            print(f"ğŸ“– è¯»å–: {source_file}")
            try:
                with open(source_file, 'r', encoding='utf-8') as f:
                    for line in f:
                        if not line.strip():
                            continue
                        try:
                            data = json.loads(line)
                            all_data.append(data)
                        except:
                            continue
                print(f"  âœ“ è¯»å–äº† {len(all_data)} æ¡æ•°æ®")
            except Exception as e:
                print(f"  âš ï¸  è¯»å–å¤±è´¥: {e}")
    
    print()
    print(f"ğŸ“Š æ€»å…±è¯»å– {len(all_data)} æ¡æ•°æ®")
    print()
    
    # åˆ†ç±»å’Œæå– Prompts
    categorized_prompts = {
        'ç”Ÿå›¾': [],
        'ç”Ÿè§†é¢‘': [],
        'AI ç¼–ç ': [],
        'æç¤ºè¯å·¥ç¨‹': [],
        'é€šç”¨': []
    }
    
    for data in all_data:
        prompt_type = categorize_prompt(data)
        categorized_prompts[prompt_type].append({
            'data': data,
            'type': prompt_type
        })
    
    print("ğŸ“‚ æ•°æ®åˆ†ç±»:")
    for prompt_type, prompts in categorized_prompts.items():
        print(f"  {prompt_type}: {len(prompts)} æ¡")
    print()
    
    # åˆ›å»º Skills
    print("ğŸ”„ è½¬æ¢ä¸º Skills...")
    all_skills = []
    stats = {
        'ç”Ÿå›¾': 0,
        'ç”Ÿè§†é¢‘': 0,
        'AI ç¼–ç ': 0,
        'æç¤ºè¯å·¥ç¨‹': 0,
        'é€šç”¨': 0,
        'total': 0,
        'skipped': 0
    }
    
    for prompt_type, prompts in categorized_prompts.items():
        print(f"  å¤„ç† {prompt_type} Prompts ({len(prompts)} æ¡)...")
        
        for item in prompts:
            data = item['data']
            quality_score = calculate_quality_score(data)
            
            # åªä¿ç•™é«˜è´¨é‡ Promptsï¼ˆ>= 60 åˆ†ï¼‰
            if quality_score >= 60:
                skill = create_skill_from_prompt(data, prompt_type)
                if skill:
                    all_skills.append(skill)
                    stats[prompt_type] += 1
                    stats['total'] += 1
            else:
                stats['skipped'] += 1
    
        print(f"  âœ“ è½¬æ¢äº† {stats[prompt_type]} ä¸ª Skills")
    
    print()
    print(f"ğŸ“Š è½¬æ¢ç»Ÿè®¡:")
    print(f"  æ€»æ•°æ®: {len(all_data)} æ¡")
    print(f"  å·²è½¬æ¢: {stats['total']} ä¸ª Skills")
    print(f"  è·³è¿‡ï¼ˆä½è´¨é‡ï¼‰: {stats['skipped']} æ¡")
    print()
    
    for prompt_type, count in stats.items():
        if prompt_type not in ['total', 'skipped']:
            print(f"  {prompt_type}: {count} ä¸ª")
    
    print()
    print(f"âœ… å·²ç”Ÿæˆ {stats['total']} ä¸ª Skills")
    print(f"ğŸ“ ä¿å­˜ä½ç½®: {OUTPUT_DIR}")
    print()
    
    # ç”ŸæˆæŠ¥å‘Š
    timestamp = datetime.now().strftime('%Y-%m-%d')
    report = {
        "timestamp": datetime.now().isoformat(),
        "total_data": len(all_data),
        "converted_skills": stats['total'],
        "skipped": stats['skipped'],
        "by_type": stats
    }
    
    report_file = os.path.join(OUTPUT_DIR, f"prompt-to-skill-conversion-{timestamp}.json")
    with open(report_file, 'w', encoding='utf-8') as f:
        json.dump(report, f, indent=2, ensure_ascii=False)
    
    print(f"ğŸ“„ æŠ¥å‘Šå·²ä¿å­˜: {report_file}")
    print()
    print("=" * 80)
    print("âœ… Prompts è½¬ Skills å®Œæˆï¼")
    print("=" * 80)
    print()
    
    # æ˜¾ç¤º Top 10 Skills
    print("ğŸ† Top 10 Skills (æŒ‰è´¨é‡åˆ†æ•°æ’åºï¼‰:")
    print()
    
    sorted_skills = sorted(all_skills, key=lambda x: x['score'], reverse=True)
    for i, skill in enumerate(sorted_skills[:10], 1):
        print(f"{i}. [{skill['score']}] {skill['name']} ({skill['type']})")
    
    return all_skills

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nâ¸ï¸  ç”¨æˆ·ä¸­æ–­")
    except Exception as e:
        print(f"\n\nâŒ é”™è¯¯: {e}")
        import traceback
        traceback.print_exc()
